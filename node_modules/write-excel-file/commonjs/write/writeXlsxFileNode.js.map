{"version":3,"file":"writeXlsxFileNode.js","names":["writeXlsxFile","data","filePath","buffer","sheetName","sheet","sheetNames","sheets","schema","columns","headerStyle","fontFamily","fontSize","orientation","stickyRowsCount","stickyColumnsCount","dateFormat","archive","Archive","generateSheets","getSharedStringsXml","getStylesXml","createTempDirectory","root","createDirectory","path","join","xl","_rels","worksheetsPath","promises","writeFile","generateWorkbookXmlRels","generateWorkbookXml","id","push","Promise","all","directory","append","rels","contentTypes","write","removeDirectory","streamToBuffer","contents","resolve","reject","fs","error","mkdir","mkdtemp","os","tmpdir","directoryPath","rm","recursive","force","stream","chunks","on","chunk","Buffer","concat"],"sources":["../../source/write/writeXlsxFileNode.js"],"sourcesContent":["import fs from 'fs'\r\nimport path from 'path'\r\nimport os from 'os'\r\n\r\nimport Archive from './archive.js'\r\n\r\nimport generateWorkbookXml from './statics/workbook.xml.js'\r\nimport generateWorkbookXmlRels from './statics/workbook.xml.rels.js'\r\nimport rels from './statics/rels.js'\r\nimport contentTypes from './statics/[Content_Types].xml.js'\r\n\r\nimport { generateSheets } from './writeXlsxFile.common.js'\r\n\r\nexport default async function writeXlsxFile(data, {\r\n\tfilePath,\r\n\tbuffer,\r\n\tsheet: sheetName,\r\n\tsheets: sheetNames,\r\n\tschema,\r\n\tcolumns,\r\n\theaderStyle,\r\n\tfontFamily,\r\n\tfontSize,\r\n\torientation,\r\n\tstickyRowsCount,\r\n\tstickyColumnsCount,\r\n\tdateFormat\r\n} = {}) {\r\n\tconst archive = new Archive(filePath)\r\n\r\n\tconst {\r\n\t\tsheets,\r\n\t\tgetSharedStringsXml,\r\n\t\tgetStylesXml\r\n\t} = generateSheets({\r\n\t\tdata,\r\n\t\tsheetName,\r\n\t\tsheetNames,\r\n\t\tschema,\r\n\t\tcolumns,\r\n\t\theaderStyle,\r\n\t\tfontFamily,\r\n\t\tfontSize,\r\n\t\torientation,\r\n\t\tstickyRowsCount,\r\n\t\tstickyColumnsCount,\r\n\t\tdateFormat\r\n\t})\r\n\r\n\t// There doesn't seem to be a way to just append a file into a subdirectory\r\n\t// in `archiver` library, hence using a hacky temporary directory workaround.\r\n\t// https://www.npmjs.com/package/archiver\r\n\tconst root = await createTempDirectory()\r\n\tconst xl = await createDirectory(path.join(root, 'xl'))\r\n\tconst _rels = await createDirectory(path.join(xl, '_rels'))\r\n\tconst worksheetsPath = await createDirectory(path.join(xl, 'worksheets'))\r\n\r\n\tconst promises = [\r\n\t\twriteFile(path.join(_rels, 'workbook.xml.rels'), generateWorkbookXmlRels({ sheets })),\r\n\t\twriteFile(path.join(xl, 'workbook.xml'), generateWorkbookXml({ sheets })),\r\n\t\twriteFile(path.join(xl, 'styles.xml'), getStylesXml()),\r\n\t\twriteFile(path.join(xl, 'sharedStrings.xml'), getSharedStringsXml())\r\n\t]\r\n\r\n\tfor (const { id, data } of sheets) {\r\n\t\tpromises.push(writeFile(path.join(worksheetsPath, `sheet${id}.xml`), data))\r\n\t}\r\n\r\n\tawait Promise.all(promises)\r\n\r\n\tarchive.directory(xl, 'xl')\r\n\tarchive.append(rels, '_rels/.rels')\r\n\tarchive.append(contentTypes, '[Content_Types].xml')\r\n\r\n\tif (filePath) {\r\n\t\tawait archive.write()\r\n\t\tawait removeDirectory(root)\r\n\t} else if (buffer) {\r\n\t\treturn streamToBuffer(archive.write())\r\n\t} else {\r\n\t\treturn archive.write()\r\n\t}\r\n}\r\n\r\nfunction writeFile(path, contents) {\r\n\treturn new Promise((resolve, reject) => {\r\n\t\tfs.writeFile(path, contents, 'utf-8', (error) => {\r\n\t\t\tif (error) {\r\n\t\t\t\treturn reject(error)\r\n\t\t\t}\r\n\t\t\tresolve()\r\n\t\t})\r\n\t})\r\n}\r\n\r\nfunction createDirectory(path) {\r\n\treturn new Promise((resolve, reject) => {\r\n\t\tfs.mkdir(path, (error) => {\r\n\t\t\tif (error) {\r\n\t\t\t\treturn reject(error)\r\n\t\t\t}\r\n\t\t\tresolve(path)\r\n\t\t})\r\n\t})\r\n}\r\n\r\nfunction createTempDirectory() {\r\n\treturn new Promise((resolve, reject) => {\r\n\t\tfs.mkdtemp(path.join(os.tmpdir(), 'write-excel-file-'), (error, directoryPath) => {\r\n\t\t\tif (error) {\r\n\t\t\t\treturn reject(error)\r\n\t\t\t}\r\n\t\t\tresolve(directoryPath)\r\n\t\t})\r\n\t})\r\n}\r\n\r\nfunction removeDirectory(path) {\r\n\treturn new Promise((resolve, reject) => {\r\n\t\tfs.rm(path, { recursive: true, force: true }, (error) => {\r\n\t\t\tif (error) {\r\n\t\t\t\treturn reject(error)\r\n\t\t\t}\r\n\t\t\tresolve(path)\r\n\t\t})\r\n\t})\r\n}\r\n\r\n// https://stackoverflow.com/a/67729663\r\nfunction streamToBuffer(stream) {\r\n\treturn new Promise((resolve, reject) => {\r\n\t\tconst chunks = []\r\n\t\tstream.on('data', (chunk) => chunks.push(chunk))\r\n\t\tstream.on('end', () => resolve(Buffer.concat(chunks)))\r\n\t\tstream.on('error', reject)\r\n\t})\r\n}"],"mappings":"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"}